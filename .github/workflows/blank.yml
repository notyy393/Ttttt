#!/bin/bash

# === Full VPS Setup: Tailscale + SSHX + Persistent Storage + Auto Restart ===

# Update system
sudo apt update && sudo apt upgrade -y

# Install required packages
sudo apt install curl unzip gnupg2 lsb-release cron python3 -y

# === Install & Configure Tailscale ===
curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).tailscale.list | sudo tee /etc/apt/sources.list.d/tailscale.list
sudo apt update
sudo apt install tailscale -y
sudo systemctl enable tailscaled
sudo systemctl start tailscaled

# Login to Tailscale (copy the link after this)
sudo tailscale up --ssh

# === Install & Configure SSHX ===
curl -s https://raw.githubusercontent.com/zeekrey/sshx/main/install.sh | bash
sshx

# === Persistent Storage Folder ===
mkdir -p ~/my-storage
echo "âœ… Persistent folder created at ~/my-storage"

# === Python File Server on port 6969 ===
cat <<EOF | sudo tee /etc/systemd/system/python-server.service
[Unit]
Description=Simple Python File Server
After=network.target

[Service]
WorkingDirectory=/home/$(whoami)/my-storage
ExecStart=/usr/bin/python3 -m http.server 6969
Restart=always
User=$(whoami)

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable python-server.service
sudo systemctl start python-server.service

# === Auto Restart VPS Every 6 Hours ===
(crontab -l 2>/dev/null; echo "0 */6 * * * /sbin/reboot") | crontab -

# === Summary ===
echo ""
echo "ðŸŽ‰ SETUP COMPLETE"
echo "------------------------------"
echo "âœ… Tailscale enabled (auto-start)"
echo "âœ… Static Tailscale IP (via: tailscale ip)"
echo "âœ… SSH over Tailscale: ssh user@tailscale-ip"
echo "âœ… SSHX installed (run: sshx)"
echo "âœ… Auto VPS reboot every 6 hours"
echo "âœ… File storage at: ~/my-storage"
echo "âœ… Access files via browser: http://<tailscale-ip>:6969"
echo "------------------------------"
tailscale ip
