#!/bin/bash

# === VPS Auto Setup Script ===
# Includes: Tailscale, SSHX, Persistent Storage, File Server, Auto Restart

echo "🛠️ Starting Full VPS Setup..."

# Update & install base packages
sudo apt update && sudo apt install curl unzip cron python3 -y

# === Setup Persistent Folder ===
mkdir -p ~/my-storage
chmod 755 ~/my-storage

# === Setup Python File Server (port 6969) ===
cat <<EOF | sudo tee /etc/systemd/system/fileserver.service >/dev/null
[Unit]
Description=Python File Server
After=network.target

[Service]
Type=simple
WorkingDirectory=/home/$USER/my-storage
ExecStart=/usr/bin/python3 -m http.server 6969
Restart=always
User=$USER

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable fileserver
sudo systemctl start fileserver

# === Setup Tailscale ===
echo "📡 Installing Tailscale..."
curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/$(lsb_release -cs).tailscale.list | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
sudo apt update && sudo apt install tailscale -y
sudo systemctl enable --now tailscaled

# Manual login step
echo "🔑 Login to Tailscale (click link below):"
sudo tailscale up --ssh

# === Setup SSHX ===
echo "🌐 Installing SSHX..."
curl -s https://raw.githubusercontent.com/zeekrey/sshx/main/install.sh | bash
echo "✅ SSHX installed. Run 'sshx' to get public terminal link."

# === Auto Restart Every 6 Hours ===
echo "⏰ Setting VPS to restart every 6 hours..."
(crontab -l 2>/dev/null; echo "0 */6 * * * /sbin/reboot") | crontab -

# === Summary ===
echo "✅ Setup Complete!"
echo "---------------------------"
echo "📁 Storage Folder: ~/my-storage"
echo "🌍 File Server: http://$(tailscale ip | head -n 1):6969"
echo "🔐 Tailscale SSH: ssh $USER@$(tailscale ip | head -n 1)"
echo "🌐 SSHX Terminal: Run 'sshx'"
echo "♻️ VPS will auto-reboot every 6 hours"
echo "---------------------------"
